<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservation</title>
  <link rel="stylesheet" href="./css/style.css" />
  <link rel="stylesheet" href="./css/reservationStyles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lora&family=Merriweather&family=Playfair+Display&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet" />
  <!-- ✅ เพิ่ม keycloak-js เข้ามาที่หน้านี้ด้วย -->
  <script src="https://cdn.jsdelivr.net/npm/keycloak-js@latest/dist/keycloak.min.js"></script>
</head>

<body>
  <header>
    <div class="order">
      <img src="https://www.sit.kmutt.ac.th/wp-content/uploads/2024/11/1-1024x238.png" alt="logo" />
      <div class="texthead">
        <h1>Study Plan & Course Reservation</h1>
      </div>
      <div class="signOut">
        <p class="ecors-fullname">Loading...</p>
        <button id="btnSignOut" class="ecors-button-manage ecors-button-signout">
          Sign Out
        </button>
      </div>
    </div>
  </header>

  <main>
    <div data-cy="period-box">
      <div data-cy="current-message-box">
        <h3 data-cy="current-message">Reservation is open</h3>
        <p data-cy="current-period">Period:</p>
      </div>
      <div data-cy="next-message-box">
        <h3 data-cy="next-message">Next reservation period</h3>
        <p data-cy="next-period">Period:</p>
      </div>
    </div>
    <div class="ecors-declared-plan">
      <p id="declareStatus">Loading...</p>
    </div>

    <div id="majorManagementSection"></div>
    
    <div id="manage-course-reservations">
      <div data-cy="course-Reservations-box">
        <h3>Course Reservations</h3>
        <p data-cy="core-courses-header">Core Courses for :</p>
        <p data-cy="core-course">Loading Course..</p>
      </div>
      <div data-cy="course-Reservations-box">
        <h3>Your Reservations</h3>
        <p>Loading reservations...</p>
      </div>
    </div>
    
    <div class="course-offerings">
      <h3>Course Offerings</h3>
      <p>Loading course offerings...</p>
    </div>
  </main>

  <footer>
    <div class="textfoot">
      <p>© 2025 School of Information Technology, KMUTT</p>
    </div>
  </footer>

  <script>
    // ==============================================================
    // reserve.html - Fixed Script (ลบส่วน Declaration Status ออก)
    // ให้ declareStatus.js จัดการเรื่อง Declaration Status แทน
    // ==============================================================

    document.addEventListener("DOMContentLoaded", () => {
      /* ============ env switch ============ */
      const isLocal = ["localhost", "127.0.0.1", "::1"].includes(
        location.hostname
      );

      // API base: โปรดักชันต้องติด prefix + /api
      const apiBase = isLocal
        ? "http://localhost:3000/api/v1"
        : "/intproj25/ssi2/itb-ecors/api/v1";

      // Keycloak config สำหรับ logout (ต้องตรงกับที่ใช้ตอน login)
      const KC = isLocal
        ? {
          url: "http://localhost:8080",
          realm: "ssi2",
          clientId: "fe-app",
        }
        : {
          url: "https://bscit.sit.kmutt.ac.th/intproj25/ft/keycloak/",
          realm: "itb-ecors",
          clientId: "itb-ecors-ssi2",
        };

      // สร้าง instance ไว้ใช้ logout ถ้าจำเป็น
      let keycloak = null;
      try {
        keycloak = new Keycloak({
          url: KC.url,
          realm: KC.realm,
          clientId: KC.clientId,
        });
      } catch (e) {
        console.warn("Keycloak JS not available on this page:", e);
      }

      /* ============ guard: ต้องมี token ============ */
      const token = sessionStorage.getItem("kcToken");
      if (!token) {
        // ยังไม่ล็อกอิน → รอหน้าบังคับให้ขึ้นหน้า login แน่นอน
        sessionStorage.setItem("forceLogin", "1");

        // แสดง reserve.html แป๊บหนึ่ง แล้วค่อยไป keycloak.html (ให้ Cypress เห็น /reserve.html)
        setTimeout(() => {
          location.href = "./keycloak.html";
        }, 500); // 0.5 วินาที
        return;
      }

      /* ============ decode ชื่อผู้ใช้ (ปลอดภัย) ============ */
      function parseJwt(t) {
        try {
          const base64Url = t.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch {
          return {};
        }
      }

      const info = parseJwt(token);
      console.log("KC token payload:", info);
      const name = info.name || info.preferred_username || "User";

      /* ============ header: update fullname ============ */
      const fullnameEl = document.querySelector(".ecors-fullname");
      if (fullnameEl) {
        fullnameEl.textContent = name;
      }

      // ============================================================
      // ❌ ลบส่วน Declaration Status ออก
      // ❌ เพราะ declareStatus.js จะจัดการเรื่องนี้แทน
      // ============================================================
      // (async () => {
      //   const declaredRes = await fetch(...);  // <-- ลบออก
      //   // ...
      // })();

      /* ============ Sign Out ============ */
      const btnSignOut = document.getElementById("btnSignOut");
      if (btnSignOut) {
        btnSignOut.addEventListener("click", () => {
          const isLocal = ["localhost", "127.0.0.1", "::1"].includes(
            location.hostname
          );

          // 1) ดึง id_token ก่อนล้าง storage ◀
          const idTokenHint = sessionStorage.getItem("kcIdToken") || "";

          // 2) เคลียร์ของกั่ง FE
          try {
            sessionStorage.clear();
          } catch (e) {
            console.warn("Cannot clear sessionStorage:", e);
          }

          try {
            localStorage.clear();
          } catch (e) {
            console.warn("Cannot clear localStorage:", e);
          }

          // 3) URL ที่จะกลับหลัง logout
          const redirectAfterLogout = isLocal
            ? "http://127.0.0.1:5500/ssi2/itb-ecors/FE/index.html"
            : "https://bscit.sit.kmutt.ac.th/intproj25/ssi2/itb-ecors/";

          // 4) ฐาน URL logout ของ Keycloak
          const logoutBase = isLocal
            ? "http://localhost:8080/realms/ssi2/protocol/openid-connect/logout"
            : "https://bscit.sit.kmutt.ac.th/intproj25/ft/keycloak/realms/itb-ecors/protocol/openid-connect/logout";

          const clientId = isLocal ? "fe-app" : "itb-ecors-ssi2";

          const params = new URLSearchParams({
            client_id: clientId,
            post_logout_redirect_uri: redirectAfterLogout,
          });

          // 5) ถ้ามี id_token_hint ให้ส่งไปด้วย (จะได้ไม่ถามหน้า confirm)
          if (idTokenHint) {
            params.append("id_token_hint", idTokenHint);
          }

          const logoutUrl = `${logoutBase}?${params.toString()}`;

          // 6) ยิง browser ไป logout
          window.location.href = logoutUrl;
        });
      }
    });
  </script>
  
  <!-- ✅ Load scripts in order -->
  <script src="./js/declaremanager.js"></script>
  <script src="./js/reservationManager.js"></script>
</body>

</html>