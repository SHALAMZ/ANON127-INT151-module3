<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Keycloak Login</title>

  <!-- CDN -->
  <script src="https://cdn.jsdelivr.net/npm/keycloak-js@latest/dist/keycloak.min.js"></script>
</head>

<body>
  <script>
    (async () => {

      console.log("[KC] page start");

      // ðŸ’¥ à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œ token à¹€à¸”à¸´à¸¡à¸—à¸´à¹‰à¸‡à¸—à¸±à¸™à¸—à¸µ (à¹€à¸žà¸·à¹ˆà¸­à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸«à¹‰ login à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸£à¸´à¸‡)
      sessionStorage.removeItem("kcToken");
      sessionStorage.removeItem("kcRefreshToken");

      const isLocal = ["localhost", "127.0.0.1", "::1"].includes(location.hostname);

      // --- âœ… à¹‚à¸›à¸£à¸”à¸±à¸à¸Šà¸±à¸™ (à¸•à¹‰à¸­à¸‡à¸¡à¸µ / à¸—à¹‰à¸²à¸¢ URL) ---
      const prodCfg = {
        url: "https://bscit.sit.kmutt.ac.th/intproj25/ft/keycloak/",  // â† à¹à¸à¹‰à¸—à¸µà¹ˆà¸™à¸µà¹ˆ
        realm: "itb-ecors",
        clientId: "itb-ecors-ssi2"
      };

      // --- à¹‚à¸¥à¸„à¸±à¸¥ ---
      const localCfg = {
        url: "http://localhost:8080/",
        realm: "ssi2",
        clientId: "fe-app"
      };

      // --- à¹ƒà¸Šà¹‰ cfg à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ ---
      const cfg = isLocal ? localCfg : prodCfg;

      // --- redirect à¸ªà¸£à¹‰à¸²à¸‡à¸ˆà¸²à¸ path à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸—à¸¸à¸ env) ---
      const redirectTo = new URL("./reserve.html", location.href).href;


      const keycloak = new Keycloak(cfg);

      console.log("[KC] init start", cfg, { redirectTo });

      try {
        const authenticated = await keycloak.init({
          onLoad: "login-required",
          checkLoginIframe: false,
          pkceMethod: "S256"
        });

        console.log("[KC] init done, authenticated =", authenticated);

        if (!authenticated) {
          console.log("[KC] not authenticated â†’ keycloak.login() with prompt=login");
          await keycloak.login({
            redirectUri: redirectTo,
            prompt: "login",   // ðŸŸ¢ à¹€à¸žà¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰
          });
          return;
        }

        // --- à¸šà¸±à¸™à¸—à¸¶à¸ token à¸¥à¸‡ sessionStorage ---
        sessionStorage.setItem("kcToken", keycloak.token);
        sessionStorage.setItem("kcRefreshToken", keycloak.refreshToken);
        sessionStorage.setItem("kcIdToken", keycloak.idToken);   // ðŸ†• à¹€à¸žà¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰


        // refresh token à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
        setInterval(async () => {
          try {
            const refreshed = await keycloak.updateToken(30);
            if (refreshed) sessionStorage.setItem("kcToken", keycloak.token);
          } catch (e) {
            console.error("[KC] refresh error", e);
          }
        }, 15000);

        // à¸ªà¸³à¹€à¸£à¹‡à¸ˆ â†’ à¹„à¸›à¸«à¸™à¹‰à¸² reserve
        location.href = redirectTo;

      } catch (err) {
        console.error("[KC] init error", err);
        alert("Authentication error. Please refresh this page.");
        location.href = "./index.html";
      }

    })();
  </script>
</body>

</html>
